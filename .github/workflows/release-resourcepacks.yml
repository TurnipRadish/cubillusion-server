name: Release Resource Packs

on:
  push:
    branches: [ main, master ]
    paths:
      - 'resourcepacks/**'
      - '.github/workflows/release-resourcepacks.yml'

permissions:
  contents: write  # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Get version info
      id: version
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        SHORT_SHA="${GITHUB_SHA:0:7}"
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡èµ„æºåŒ…ä¿¡æ¯
        if [ -d "resourcepacks" ]; then
          PACK_COUNT=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | wc -l)
          PACK_NAMES=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')
          echo "pack_count=$PACK_COUNT" >> $GITHUB_OUTPUT
          echo "pack_names=$PACK_NAMES" >> $GITHUB_OUTPUT
          echo "å‘ç° $PACK_COUNT ä¸ªèµ„æºåŒ…: $PACK_NAMES"
        else
          echo "pack_count=0" >> $GITHUB_OUTPUT
          echo "pack_names=" >> $GITHUB_OUTPUT
        fi
    
    - name: Create combined resourcepack archive
      id: create_archive
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_combine
        
        # æ£€æŸ¥resourcepacksç›®å½•æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
        if [ ! -d "resourcepacks" ] || [ -z "$(ls -A resourcepacks/)" ]; then
          echo "âŒ resourcepacksç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
    
        # åˆå¹¶æ‰€æœ‰èµ„æºåŒ…æ–‡ä»¶åˆ°åŒä¸€ç›®å½•ï¼ˆå¹³é“ºåˆå¹¶ï¼‰
        echo "ğŸ“¦ æ­£åœ¨å¹³é“ºåˆå¹¶èµ„æºåŒ…..."
        for resourcepack in resourcepacks/*/; do
          if [ -d "$resourcepack" ]; then
            packname=$(basename "$resourcepack")
            echo "æ­£åœ¨åˆå¹¶: $packname"
            
            # å¤åˆ¶è¯¥èµ„æºåŒ…å†…çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹åˆ°åˆå¹¶ç›®å½•
            # ä½¿ç”¨rsyncæˆ–cpæ¥åˆå¹¶ï¼ŒåŒåæ–‡ä»¶ä¼šè¢«è¦†ç›–
            if command -v rsync >/dev/null 2>&1; then
              rsync -a "$resourcepack"/* temp_combine/ 2>/dev/null || true
            else
              cp -r "$resourcepack"/* temp_combine/ 2>/dev/null || true
            fi
          fi
        done
        
        # æ£€æŸ¥åˆå¹¶ç»“æœ
        if [ -n "$(ls -A temp_combine/ 2>/dev/null)" ]; then
          ARCHIVE_NAME="cubi-merged-resourcepack.zip"
          cd temp_combine
          zip -r "../$ARCHIVE_NAME" .
          cd ..
          
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… å¹³é“ºåˆå¹¶å®Œæˆ: $ARCHIVE_NAME"
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…ç»Ÿè®¡
          echo "ğŸ“Š åˆå¹¶ç»Ÿè®¡:"
          echo "æ€»æ–‡ä»¶æ•°: $(unzip -l "$ARCHIVE_NAME" | wc -l)"
          echo "èµ„æºåŒ…æ•°é‡: $(find resourcepacks -maxdepth 1 -type d | tail -n +2 | wc -l)"
          
        else
          echo "âŒ åˆå¹¶åç›®å½•ä¸ºç©º"
          exit 1
        fi
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf temp_combine


    - name: Upload ZIP to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "cubi-merged-resourcepack.zip"
        target: "/home/admin/minecraft-server/resourcepacks/"
    
    - name: Upload and update server config
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/admin/minecraft-server/resourcepacks/
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸ
          if [ -f "cubi-merged-resourcepack.zip" ]; then
            echo "âœ… èµ„æºåŒ…ä¸Šä¼ æˆåŠŸ"
            ls -la cubi-merged-resourcepack.zip
          else
            echo "âŒ èµ„æºåŒ…ä¸Šä¼ å¤±è´¥"
            exit 1
          fi
          
          # è·å–æœåŠ¡å™¨IPå¹¶æ›´æ–°é…ç½®
          SERVER_IP=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')
          sed -i "s|^resource-pack=.*|resource-pack=http://$SERVER_IP/download/cubi-merged-resourcepack.zip|" ../server.properties
          
          echo "âœ… é…ç½®æ›´æ–°å®Œæˆ"
          grep "^resource-pack=" ../server.properties

