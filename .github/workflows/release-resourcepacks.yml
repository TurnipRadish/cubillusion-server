name: Release Resource Packs

on:
  push:
    branches: [ main, master ]
    paths:
      - 'resourcepacks/**'
      - '.github/workflows/release-resourcepacks.yml'

permissions:
  contents: write  # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Get version info
      id: version
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        SHORT_SHA="${GITHUB_SHA:0:7}"
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡èµ„æºåŒ…ä¿¡æ¯
        if [ -d "resourcepacks" ]; then
          PACK_COUNT=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | wc -l)
          PACK_NAMES=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')
          echo "pack_count=$PACK_COUNT" >> $GITHUB_OUTPUT
          echo "pack_names=$PACK_NAMES" >> $GITHUB_OUTPUT
          echo "å‘ç° $PACK_COUNT ä¸ªèµ„æºåŒ…: $PACK_NAMES"
        else
          echo "pack_count=0" >> $GITHUB_OUTPUT
          echo "pack_names=" >> $GITHUB_OUTPUT
        fi
    
    - name: Create combined resourcepack archive
      id: create_archive
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_combine
        
        # æ£€æŸ¥resourcepacksç›®å½•æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
        if [ ! -d "resourcepacks" ] || [ -z "$(ls -A resourcepacks/)" ]; then
          echo "âŒ resourcepacksç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
        
        # å¤åˆ¶æ‰€æœ‰èµ„æºåŒ…æ–‡ä»¶å¤¹åˆ°ä¸´æ—¶ç›®å½•
        echo "ğŸ“¦ æ­£åœ¨åˆå¹¶èµ„æºåŒ…..."
        for dir in resourcepacks/*/; do
          if [ -d "$dir" ]; then
            dirname=$(basename "$dir")
            echo "æ­£åœ¨å¤„ç†: $dirname"
            cp -r "$dir" "temp_combine/$dirname"
          fi
        done
        
        # åˆ›å»ºå‹ç¼©åŒ…
        if [ -n "$(ls -A temp_combine/)" ]; then
          ARCHIVE_NAME="combined-resourcepacks-${{ steps.version.outputs.timestamp }}.zip"
          cd temp_combine
          zip -r "../$ARCHIVE_NAME" .
          cd ..
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… åˆå¹¶å®Œæˆ: $ARCHIVE_NAME"
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…å†…å®¹
          echo "ğŸ“ å‹ç¼©åŒ…å†…å®¹:"
          unzip -l "$ARCHIVE_NAME" | head -20
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯åˆå¹¶çš„èµ„æºåŒ…"
          exit 1
        fi
    
    - name: Create Resource Pack Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: resourcepack-${{ steps.version.outputs.timestamp }}-${{ steps.version.outputs.short_sha }}
        name: "åˆå¹¶èµ„æºåŒ… v1.0.${{ github.run_number }}"
        body: |
          ## ğŸ¨ èµ„æºåŒ…åˆå¹¶å‘å¸ƒ
          
          ### å‘å¸ƒä¿¡æ¯
          | é¡¹ç›® | è¯¦æƒ… |
          |------|------|
          | **ç‰ˆæœ¬** | v1.0.${{ github.run_number }} |
          | **åŒ…å«èµ„æºåŒ…** | ${{ steps.version.outputs.pack_count }} ä¸ª |
          | **èµ„æºåŒ…åˆ—è¡¨** | ${{ steps.version.outputs.pack_names }} |
          | **æäº¤å“ˆå¸Œ** | `${{ steps.version.outputs.short_sha }}` |
          | **è§¦å‘è€…** | @${{ github.actor }} |
          | **å‘å¸ƒæ—¶é—´** | ${{ github.event.head_commit.timestamp }} |
          
          ### å‹ç¼©åŒ…ä¿¡æ¯
          - **æ–‡ä»¶å**: `${{ steps.create_archive.outputs.archive_name }}`
          - **åŒ…å«ç›®å½•**: æ‰€æœ‰resourcepacksä¸‹çš„å­æ–‡ä»¶å¤¹
          - **æ ¼å¼**: ZIPå‹ç¼©åŒ…
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ `${{ steps.create_archive.outputs.archive_name }}`
          2. è§£å‹åˆ°Minecraftçš„resourcepacksç›®å½•
          3. åœ¨æ¸¸æˆä¸­é€‰æ‹©éœ€è¦çš„èµ„æºåŒ…
          
          ### å˜æ›´å†…å®¹
          **æäº¤ä¿¡æ¯:**  
          ${{ github.event.head_commit.message }}
          
          ---
          *ğŸ¤– è‡ªåŠ¨åˆå¹¶ç”Ÿæˆ - [æŸ¥çœ‹å·¥ä½œæµ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
        draft: false
        prerelease: false
        files: |
          ${{ steps.create_archive.outputs.archive_name }}
          # ç§»é™¤äº†ä¸å­˜åœ¨çš„README.mdå’ŒLICENSEæ–‡ä»¶
