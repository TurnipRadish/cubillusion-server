name: Release Resource Packs

on:
  push:
    branches: [ main, master ]
    paths:
      - 'resourcepacks/**'
      - '.github/workflows/release-resourcepacks.yml'

permissions:
  contents: write  # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Get version info
      id: version
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        SHORT_SHA="${GITHUB_SHA:0:7}"
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡èµ„æºåŒ…ä¿¡æ¯
        if [ -d "resourcepacks" ]; then
          PACK_COUNT=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | wc -l)
          PACK_NAMES=$(find resourcepacks -maxdepth 1 -type d | tail -n +2 | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')
          echo "pack_count=$PACK_COUNT" >> $GITHUB_OUTPUT
          echo "pack_names=$PACK_NAMES" >> $GITHUB_OUTPUT
          echo "å‘ç° $PACK_COUNT ä¸ªèµ„æºåŒ…: $PACK_NAMES"
        else
          echo "pack_count=0" >> $GITHUB_OUTPUT
          echo "pack_names=" >> $GITHUB_OUTPUT
        fi
    
    - name: Create combined resourcepack archive
      id: create_archive
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_combine
        
        # æ£€æŸ¥resourcepacksç›®å½•æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
        if [ ! -d "resourcepacks" ] || [ -z "$(ls -A resourcepacks/)" ]; then
          echo "âŒ resourcepacksç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
    
        # åˆå¹¶æ‰€æœ‰èµ„æºåŒ…æ–‡ä»¶åˆ°åŒä¸€ç›®å½•ï¼ˆå¹³é“ºåˆå¹¶ï¼‰
        echo "ğŸ“¦ æ­£åœ¨å¹³é“ºåˆå¹¶èµ„æºåŒ…..."
        for resourcepack in resourcepacks/*/; do
          if [ -d "$resourcepack" ]; then
            packname=$(basename "$resourcepack")
            echo "æ­£åœ¨åˆå¹¶: $packname"
            
            # å¤åˆ¶è¯¥èµ„æºåŒ…å†…çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹åˆ°åˆå¹¶ç›®å½•
            # ä½¿ç”¨rsyncæˆ–cpæ¥åˆå¹¶ï¼ŒåŒåæ–‡ä»¶ä¼šè¢«è¦†ç›–
            if command -v rsync >/dev/null 2>&1; then
              rsync -a "$resourcepack"/* temp_combine/ 2>/dev/null || true
            else
              cp -r "$resourcepack"/* temp_combine/ 2>/dev/null || true
            fi
          fi
        done
        
        # æ£€æŸ¥åˆå¹¶ç»“æœ
        if [ -n "$(ls -A temp_combine/ 2>/dev/null)" ]; then
          ARCHIVE_NAME="merged-resourcepack-${{ steps.version.outputs.timestamp }}.zip"
          cd temp_combine
          
          # æ˜¾ç¤ºåˆå¹¶åçš„æ–‡ä»¶ç»“æ„
          echo "ğŸ“ åˆå¹¶åçš„æ–‡ä»¶ç»“æ„:"
          find . -type f | head -20
          
          # åˆ›å»ºå‹ç¼©åŒ…
          zip -r "../$ARCHIVE_NAME" .
          cd ..
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… å¹³é“ºåˆå¹¶å®Œæˆ: $ARCHIVE_NAME"
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…ç»Ÿè®¡
          echo "ğŸ“Š åˆå¹¶ç»Ÿè®¡:"
          echo "æ€»æ–‡ä»¶æ•°: $(unzip -l "$ARCHIVE_NAME" | wc -l)"
          echo "èµ„æºåŒ…æ•°é‡: $(find resourcepacks -maxdepth 1 -type d | tail -n +2 | wc -l)"
          
        else
          echo "âŒ åˆå¹¶åç›®å½•ä¸ºç©º"
          exit 1
        fi
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf temp_combine

    # - name: Copy archive to repository root and commit
    #   run: |
    #     # æäº¤åˆ°mainåˆ†æ”¯
    #     git config --global user.name "GitHub Actions"
    #     git config --global user.email "actions@github.com"
    #     git add "${{ steps.create_archive.outputs.archive_name }}"
    #     git commit -m "feat: add merged resourcepack for CDN - ${{ steps.version.outputs.timestamp }}"
    #     git push
    
    # - name: Create Resource Pack Release
    #   uses: softprops/action-gh-release@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     tag_name: resourcepack-${{ steps.version.outputs.timestamp }}-${{ steps.version.outputs.short_sha }}
    #     name: "åˆå¹¶èµ„æºåŒ… v1.0.${{ github.run_number }}"
    #     body: |
    #       ## ğŸ¨ èµ„æºåŒ…å¹³é“ºåˆå¹¶å‘å¸ƒ
          
    #       ### åˆå¹¶æ–¹å¼
    #       - **å¹³é“ºåˆå¹¶**: æ‰€æœ‰èµ„æºåŒ…çš„æ–‡ä»¶ç›´æ¥åˆå¹¶åˆ°åŒä¸€ç›®å½•
    #       - **å†²çªå¤„ç†**: åŒåæ–‡ä»¶æŒ‰å¤„ç†é¡ºåºè¦†ç›–ï¼ˆåå¤„ç†çš„è¦†ç›–å…ˆå¤„ç†çš„ï¼‰
    #       - **æ–‡ä»¶å†²çªæ•°**: ${{ steps.create_archive.outputs.conflict_count || 0 }} ä¸ª
          
    #       ### ä½¿ç”¨è¯´æ˜
    #       1. ä¸‹è½½åˆå¹¶åŒ…å¹¶è§£å‹åˆ°Minecraftçš„resourcepacksç›®å½•
    #       2. åœ¨æ¸¸æˆä¸­å¯ç”¨æ­¤èµ„æºåŒ…å³å¯è·å¾—æ‰€æœ‰èµ„æºåŒ…çš„æ•ˆæœ
    #       3. åŒåæ–‡ä»¶å·²è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
          
    #       ### å‘å¸ƒä¿¡æ¯
    #       | é¡¹ç›® | è¯¦æƒ… |
    #       |------|------|
    #       | **ç‰ˆæœ¬** | v1.0.${{ github.run_number }} |
    #       | **åŒ…å«èµ„æºåŒ…** | ${{ steps.version.outputs.pack_count }} ä¸ª |
    #       | **èµ„æºåŒ…åˆ—è¡¨** | ${{ steps.version.outputs.pack_names }} |
    #       | **æäº¤å“ˆå¸Œ** | `${{ steps.version.outputs.short_sha }}` |
    #       | **è§¦å‘è€…** | @${{ github.actor }} |
    #       | **å‘å¸ƒæ—¶é—´** | ${{ github.event.head_commit.timestamp }} |
          
    #       ### å‹ç¼©åŒ…ä¿¡æ¯
    #       - **æ–‡ä»¶å**: `${{ steps.create_archive.outputs.archive_name }}`
    #       - **åŒ…å«ç›®å½•**: æ‰€æœ‰resourcepacksä¸‹çš„å­æ–‡ä»¶å¤¹
    #       - **æ ¼å¼**: ZIPå‹ç¼©åŒ…
          
    #       ### ä½¿ç”¨è¯´æ˜
    #       1. ä¸‹è½½ `${{ steps.create_archive.outputs.archive_name }}`
    #       2. è§£å‹åˆ°Minecraftçš„resourcepacksç›®å½•
    #       3. åœ¨æ¸¸æˆä¸­é€‰æ‹©éœ€è¦çš„èµ„æºåŒ…
          
    #       ### å˜æ›´å†…å®¹
    #       **æäº¤ä¿¡æ¯:**  
    #       ${{ github.event.head_commit.message }}
          
    #       ---
    #       *ğŸ¤– è‡ªåŠ¨åˆå¹¶ç”Ÿæˆ - [æŸ¥çœ‹å·¥ä½œæµ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
    #     draft: false
    #     prerelease: false
    #     files: |
    #       ${{ steps.create_archive.outputs.archive_name }}
    #       # ç§»é™¤äº†ä¸å­˜åœ¨çš„README.mdå’ŒLICENSEæ–‡ä»¶
    
    - name: Publish to Gitee Release
      id: gitee_release
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # å®‰è£… jqï¼ˆè§£æ JSONï¼‰
        sudo apt-get install -y jq
        
        TAG_NAME="resourcepack-${{ steps.version.outputs.timestamp }}"
        ARCHIVE="${{ steps.create_archive.outputs.archive_name }}"
        
        # åˆ›å»º Release å¹¶è·å– ID
        RELEASE_ID=$(curl -s -X POST \
          -H "Authorization: token $GITEE_TOKEN" \
          -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"èµ„æºåŒ… $TAG_NAME\"}" \
          "https://gitee.com/api/v5/repos/turnipradish/cubillusion-server/releases" | jq -r '.id')
        
        # ä¸Šä¼ æ–‡ä»¶
        curl -s -X POST \
          -H "Authorization: token $GITEE_TOKEN" \
          -F "file=@$ARCHIVE" \
          -F "name=$ARCHIVE" \
          "https://gitee.com/api/v5/repos/turnipradish/cubillusion-server/releases/$RELEASE_ID/attach_files"
        
        # è¾“å‡ºç›´é“¾ï¼ˆå…³é”®ï¼ï¼‰
        DOWNLOAD_URL="https://gitee.com/turnipradish/cubillusion-server/releases/download/$TAG_NAME/$ARCHIVE"
        echo "gitee_download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT


    - name: Update Server Properties
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/admin/minecraft-server
          # æ›´æ–°èµ„æºåŒ…é“¾æ¥
          sed -i "s|^resource-pack=.*|resource-pack=${{ steps.gitee_release.outputs.gitee_download_url }}|" server.properties
          # å¯é€‰ï¼šæ·»åŠ  SHA1 æ ¡éªŒï¼ˆæ¨èï¼‰
          echo "âœ… å·²æ›´æ–° resource-pack é“¾æ¥"
