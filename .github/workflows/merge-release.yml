name: Merge and Release Resource Packs

on:
  # è§¦å‘æ¡ä»¶1ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'å‘å¸ƒæ ‡ç­¾'
        required: true
        default: 'v1.0.0'
  # è§¦å‘æ¡ä»¶2ï¼šæ¨é€åˆ°ç‰¹å®šåˆ†æ”¯
  push:
    branches: [ main, master ]
    paths:
      - 'resourcepacks/**'
  # è§¦å‘æ¡ä»¶3ï¼šåˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘
  push:
    tags: [ 'resourcepack-*' ]

jobs:
  merge-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        mkdir -p scripts
        echo "ğŸ“¦ æ£€æŸ¥èµ„æºåŒ…ç›®å½•..."
        ls -la resourcepacks/ || echo "æ— resourcepacksç›®å½•"
        
    - name: Merge resource packs
      id: merge
      run: |
        echo "ğŸ”„ å¼€å§‹åˆå¹¶èµ„æºåŒ…..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºåŒ…
        if [ ! -d "resourcepacks" ] || [ -z "$(ls -A resourcepacks/*.zip 2>/dev/null)" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°èµ„æºåŒ…ï¼Œè·³è¿‡åˆå¹¶"
          echo "RESOURCEPACK_FILE=" >> $GITHUB_ENV
          exit 0
        fi
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        TEMP_DIR=$(mktemp -d)
        MERGED_DIR="$TEMP_DIR/merged"
        OUTPUT_ZIP="merged-resourcepack-$(date +%Y%m%d%H%M%S).zip"
        
        mkdir -p "$MERGED_DIR"
        
        # åˆå¹¶æ‰€æœ‰èµ„æºåŒ…
        for pack in resourcepacks/*.zip; do
          if [ -f "$pack" ]; then
            echo "ğŸ“¦ åˆå¹¶: $(basename $pack)"
            unzip -q -o "$pack" -d "$MERGED_DIR/" 2>/dev/null || true
          fi
        done
        
        # åˆ›å»ºæœ€ç»ˆåˆå¹¶åŒ…
        cd "$MERGED_DIR"
        zip -r "../$OUTPUT_ZIP" . > /dev/null
        cd -
        mv "$TEMP_DIR/$OUTPUT_ZIP" .
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf "$TEMP_DIR"
        
        echo "âœ… èµ„æºåŒ…åˆå¹¶å®Œæˆ: $OUTPUT_ZIP"
        echo "RESOURCEPACK_FILE=$OUTPUT_ZIP" >> $GITHUB_ENV
        
    - name: Create Release
      if: env.RESOURCEPACK_FILE != ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: resourcepack-$(date +%Y%m%d%H%M%S)
        name: "åˆå¹¶èµ„æºåŒ… $(date +'%Y-%m-%d %H:%M')"
        body: |
          ## ğŸ¨ è‡ªåŠ¨åˆå¹¶çš„èµ„æºåŒ…
          
          **ç”Ÿæˆæ—¶é—´**: $(date)
          
          **åŒ…å«çš„èµ„æºåŒ…**:
          $(ls resourcepacks/*.zip 2>/dev/null | sed 's/^/- /' || echo "æ— èµ„æºåŒ…")
          
          **ä½¿ç”¨è¯´æ˜**:
          1. å°†æ­¤èµ„æºåŒ…æ”¾å…¥å®¢æˆ·ç«¯çš„ `resourcepacks` æ–‡ä»¶å¤¹
          2. æˆ–åœ¨æœåŠ¡å™¨ `server.properties` ä¸­é…ç½®ä¸‹è½½é“¾æ¥
          
          **æ–‡ä»¶ä¿¡æ¯**:
          - æ–‡ä»¶å: ${{ env.RESOURCEPACK_FILE }}
          - å¤§å°: $(ls -lh ${{ env.RESOURCEPACK_FILE }} | awk '{print $5}')
        files: ${{ env.RESOURCEPACK_FILE }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify main deployment
      if: env.RESOURCEPACK_FILE != ''
      run: |
        echo "ğŸ‰ èµ„æºåŒ…å‘å¸ƒå®Œæˆ!"
        echo "ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/latest/download/${{ env.RESOURCEPACK_FILE }}"
