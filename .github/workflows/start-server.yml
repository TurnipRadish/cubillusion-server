name: Start Or Restart Server

on:
  push:
    branches: [ main, master ]
    paths:
      - 'datapacks/**'
      - '!datapacks/*/data/*/function/**'  
      - '!datapacks/*/data/*/advancement/**'  
      - '!datapacks/*/data/*/loot_table/**'  
      - '.github/workflows/start-server.yml'

jobs:
  start:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Restart Minecraft Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 停止screen中的服务器
          screen -S mc -X quit || echo "没有运行的Minecraft服务器"
          sleep 10

          # 确保进程完全停止
          pkill -f "server.jar" || echo "进程已停止"
          sleep 3

          # 重启服务器
          cd /home/admin/minecraft-server
          screen -S mc -dm bash -c "java -jar server.jar nogui"
          sleep 10

          # 检查服务器是否在screen中运行
          if screen -list | grep -q "mc"; then
              echo "✅ Minecraft服务器在screen中启动成功"
          else
              echo "❌ Minecraft服务器启动失败"
              exit 1
          fi
