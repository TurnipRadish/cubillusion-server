name: Deploy to Minecraft Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Upload files via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/home/admin/mc-git-repo"
        strip_components: 0
        rm: false
      
    - name: Setup symlinks and backup
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -x
          echo "ğŸš€ å¼€å§‹è®¾ç½®ç¬¦å·é“¾æ¥..."
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨å’Œæƒé™æ­£ç¡®
          sudo mkdir -p /home/admin/mc-git-repo
          sudo chown admin:admin /home/admin/mc-git-repo
          sudo chmod 755 /home/admin/mc-git-repo
          
          # å¤‡ä»½æœåŠ¡å™¨æ•°æ®åŒ…å’Œèµ„æºåŒ…
          if [ -d "/home/admin/minecraft-server/world/datapacks" ] && [ ! -L "/home/admin/minecraft-server/world/datapacks" ]; then
            mv "/home/admin/minecraft-server/world/datapacks" "/home/admin/minecraft-server/world/datapacks.backup.$(date +%Y%m%d%H%M%S)"
            echo "âœ… åŸdatapackså·²å¤‡ä»½"
          fi
          
          if [ -d "/home/admin/minecraft-server/resourcepacks" ] && [ ! -L "/home/admin/minecraft-server/resourcepacks" ]; then
            mv "/home/admin/minecraft-server/resourcepacks" "/home/admin/minecraft-server/resourcepacks.backup.$(date +%Y%m%d%H%M%S)"
            echo "âœ… åŸresourcepackså·²å¤‡ä»½"
          fi

          # è‡ªåŠ¨åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆæ–‡ä»¶å·²ä¸Šä¼ ï¼Œå¯ä»¥å®‰å…¨åˆ›å»ºï¼‰
          ln -sf /home/admin/mc-git-repo/datapacks /home/admin/minecraft-server/world/datapacks
          ln -sf /home/admin/mc-git-repo/resourcepacks /home/admin/minecraft-server/resourcepacks
          
          echo "âœ… ç¬¦å·é“¾æ¥åˆ›å»ºå®Œæˆ"
          echo "å½“å‰æ–‡ä»¶ç»“æ„:"
          ls -la /home/admin/mc-git-repo/
          echo "ç¬¦å·é“¾æ¥çŠ¶æ€:"
          ls -la /home/admin/minecraft-server/world/datapacks
          ls -la /home/admin/minecraft-server/resourcepacks

          # æ£€æµ‹å¹¶é‡å¯MinecraftæœåŠ¡å™¨
          # æ£€æµ‹å¹¶é‡å¯MinecraftæœåŠ¡å™¨
          echo "ğŸ”„ æ£€æŸ¥MinecraftæœåŠ¡å™¨çŠ¶æ€..."
          
          # åœæ­¢å¯èƒ½è¿è¡Œçš„æœåŠ¡å™¨
          pkill -f "server.jar" || true
          sleep 5
          
          # å¯åŠ¨æœåŠ¡å™¨
          echo "ğŸš€ å¯åŠ¨MinecraftæœåŠ¡å™¨..."
          cd /home/***/minecraft-server
          ./start.sh
          sleep 10
          
          # æ›´å¯é çš„å¯åŠ¨éªŒè¯ï¼ˆå¤šç§æ£€æµ‹æ–¹å¼ï¼‰
          echo "=== è¯¦ç»†å¯åŠ¨çŠ¶æ€æ£€æŸ¥ ==="
          echo "1. Screenä¼šè¯åˆ—è¡¨:"
          screen -list
          echo "2. Javaè¿›ç¨‹æ£€æŸ¥:"
          pgrep -f "server.jar" && echo "âœ… æ‰¾åˆ°server.jarè¿›ç¨‹" || echo "âŒ æœªæ‰¾åˆ°server.jarè¿›ç¨‹"
          echo "3. æ‰€æœ‰screenä¼šè¯:"
          screen -ls
          
          # ä½¿ç”¨å¤šç§æ–¹å¼éªŒè¯å¯åŠ¨æˆåŠŸ
          if screen -list | grep -q "mc"; then
            echo "âœ… æ–¹å¼1: screenæ£€æµ‹åˆ°mcä¼šè¯"
            SCREEN_SUCCESS=true
          else
            echo "âŒ æ–¹å¼1: screenæœªæ£€æµ‹åˆ°mcä¼šè¯"
            SCREEN_SUCCESS=false
          fi
          
          if pgrep -f "server.jar" > /dev/null; then
            echo "âœ… æ–¹å¼2: æ£€æµ‹åˆ°server.jarè¿›ç¨‹"
            PROCESS_SUCCESS=true
          else
            echo "âŒ æ–¹å¼2: æœªæ£€æµ‹åˆ°server.jarè¿›ç¨‹"
            PROCESS_SUCCESS=true
          fi
          
          # åªè¦è¿›ç¨‹å­˜åœ¨å°±è®¤ä¸ºå¯åŠ¨æˆåŠŸ
          if pgrep -f "server.jar" > /dev/null; then
            echo "ğŸ‰ MinecraftæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼"
            echo "ğŸ“Š æœåŠ¡å™¨ä¿¡æ¯:"
            ps aux | grep server.jar | grep -v grep
          else
            echo "âŒ MinecraftæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "start.shå†…å®¹:"
            cat start.sh
            echo "æ–‡ä»¶åˆ—è¡¨:"
            ls -la
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å…¨éƒ¨å®Œæˆï¼"
