name: Deploy to Minecraft Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Deploy using tar over SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -x
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          sudo mkdir -p /home/admin/mc-git-repo
          sudo chown admin:admin /home/admin/mc-git-repo
          sudo chmod 755 /home/admin/mc-git-repo
          
          # ä½¿ç”¨tarä¼ è¾“æ–‡ä»¶ï¼ˆæ›´å¯é ï¼‰
          cd /home/admin/mc-git-repo
          echo "å½“å‰ç›®å½•: $(pwd)"
          ls -la
          
          # æ¸…ç©ºç›®å½•ï¼ˆå‡†å¤‡æ¥æ”¶æ–°æ–‡ä»¶ï¼‰
          sudo rm -rf ./*
          
          echo "âœ… ç›®å½•å‡†å¤‡å®Œæˆ"
          
    - name: Upload files via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/home/admin/mc-git-repo"
        strip_components: 0
        rm: false
