name: Deploy to Minecraft Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Upload files via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/home/admin/mc-git-repo"
        strip_components: 0
        rm: false
      
    - name: Setup symlinks and backup
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -x
          echo "ğŸš€ å¼€å§‹è®¾ç½®ç¬¦å·é“¾æ¥..."
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨å’Œæƒé™æ­£ç¡®
          sudo mkdir -p /home/admin/mc-git-repo
          sudo chown admin:admin /home/admin/mc-git-repo
          sudo chmod 755 /home/admin/mc-git-repo
          
          # å¤‡ä»½æœåŠ¡å™¨æ•°æ®åŒ…å’Œèµ„æºåŒ…
          if [ -d "/home/admin/minecraft-server/world/datapacks" ] && [ ! -L "/home/admin/minecraft-server/world/datapacks" ]; then
            mv "/home/admin/minecraft-server/world/datapacks" "/home/admin/minecraft-server/world/datapacks.backup.$(date +%Y%m%d%H%M%S)"
            echo "âœ… åŸdatapackså·²å¤‡ä»½"
          fi
          
          if [ -d "/home/admin/minecraft-server/resourcepacks" ] && [ ! -L "/home/admin/minecraft-server/resourcepacks" ]; then
            mv "/home/admin/minecraft-server/resourcepacks" "/home/admin/minecraft-server/resourcepacks.backup.$(date +%Y%m%d%H%M%S)"
            echo "âœ… åŸresourcepackså·²å¤‡ä»½"
          fi

          # è‡ªåŠ¨åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆæ–‡ä»¶å·²ä¸Šä¼ ï¼Œå¯ä»¥å®‰å…¨åˆ›å»ºï¼‰
          ln -sf /home/admin/mc-git-repo/datapacks /home/admin/minecraft-server/world/datapacks
          ln -sf /home/admin/mc-git-repo/resourcepacks /home/admin/minecraft-server/resourcepacks
          
          echo "âœ… ç¬¦å·é“¾æ¥åˆ›å»ºå®Œæˆ"
          echo "å½“å‰æ–‡ä»¶ç»“æ„:"
          ls -la /home/admin/mc-git-repo/
          echo "ç¬¦å·é“¾æ¥çŠ¶æ€:"
          ls -la /home/admin/minecraft-server/world/datapacks
          ls -la /home/admin/minecraft-server/resourcepacks

          # æ£€æµ‹å¹¶é‡å¯MinecraftæœåŠ¡å™¨
          echo "ğŸ”„ æ£€æŸ¥MinecraftæœåŠ¡å™¨çŠ¶æ€..."
          if screen -list | grep -q "mc"; then
            echo "ğŸ® æ£€æµ‹åˆ°mcæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œæ‰§è¡Œé‡å¯..."
            # å®‰å…¨åœæ­¢æœåŠ¡å™¨
            screen -S mc -X quit
            echo "â³ ç­‰å¾…æœåŠ¡å™¨åœæ­¢..."
            sleep 10
            # ç¡®ä¿è¿›ç¨‹å®Œå…¨åœæ­¢
            pkill -f "server.jar" || true
            sleep 5
          fi
          
          # å¯åŠ¨æœåŠ¡å™¨
          echo "ğŸš€ å¯åŠ¨MinecraftæœåŠ¡å™¨..."
          cd /home/admin/minecraft-server
          ./start.sh
          sleep 10
          
          # éªŒè¯å¯åŠ¨çŠ¶æ€
          if screen -list | grep -q "mc"; then
            echo "âœ… MinecraftæœåŠ¡å™¨é‡å¯æˆåŠŸ"
          else
            echo "âŒ MinecraftæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å…¨éƒ¨å®Œæˆï¼"
