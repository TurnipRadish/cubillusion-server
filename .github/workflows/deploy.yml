name: Deploy to Minecraft Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy files via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°MinecraftæœåŠ¡å™¨..."
          
          # åˆ›å»ºæˆ–æ¸…ç©ºGitä»“åº“ç›®å½•
          mkdir -p /home/admin/mc-git-repo
          cd /home/admin/mc-git-repo
          
          # åŒæ­¥GitHubæ–‡ä»¶åˆ°ä¸­é—´ç›®å½•ï¼ˆæ’é™¤.gitç­‰æ–‡ä»¶ï¼‰
          echo "ğŸ“ åŒæ­¥æ–‡ä»¶åˆ°Gitä»“åº“ç›®å½•..."
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.gitignore' \
            $GITHUB_WORKSPACE/ /home/admin/mc-git-repo/
          
          # ç¡®ä¿MinecraftæœåŠ¡å™¨ç›®å½•å­˜åœ¨
          mkdir -p /home/admin/minecraft-server/world/datapacks
          mkdir -p /home/admin/minecraft-server/resourcepacks
          
          # åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          echo "ğŸ”— åˆ›å»ºç¬¦å·é“¾æ¥..."
          if [ ! -L "/home/admin/minecraft-server/world/datapacks" ]; then
            # å¤‡ä»½åŸç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "/home/admin/minecraft-server/world/datapacks" ]; then
              mv /home/admin/minecraft-server/world/datapacks /home/admin/minecraft-server/world/datapacks.backup.$(date +%Y%m%d%H%M%S)
            fi
            # åˆ›å»ºç¬¦å·é“¾æ¥
            ln -sf /home/admin/mc-git-repo/datapacks /home/admin/minecraft-server/world/datapacks
          fi
          
          if [ ! -L "/home/admin/minecraft-server/resourcepacks" ]; then
            if [ -d "/home/admin/minecraft-server/resourcepacks" ]; then
              mv /home/admin/minecraft-server/resourcepacks /home/admin/minecraft-server/resourcepacks.backup.$(date +%Y%m%d%H%M%S)
            fi
            ln -sf /home/admin/mc-git-repo/resourcepacks /home/admin/minecraft-server/resourcepacks
          fi
          
          # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
          echo "ğŸ”’ è®¾ç½®æ–‡ä»¶æƒé™..."
          # sudo chown -R player1:player1 /home/admin/minecraft-server/
          sudo chown -R admin:admin /home/admin/mc-git-repo/
          sudo chmod -R 755 /home/admin/mc-git-repo/
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å’Œç¬¦å·é“¾æ¥åˆ›å»ºå®Œæˆ"
          
          # ä½¿ç”¨ä½ çš„start.shè„šæœ¬é‡å¯æœåŠ¡å™¨
          echo "ğŸ”„ é‡å¯MinecraftæœåŠ¡å™¨..."
          cd /home/admin/minecraft-server
          
          # åœæ­¢å½“å‰æœåŠ¡å™¨ï¼ˆå¦‚æœè¿è¡Œä¸­ï¼‰
          if screen -list | grep -q "mc"; then
            screen -S mc -X stuff "stop^M"
            echo "â³ ç­‰å¾…æœåŠ¡å™¨å®‰å…¨å…³é—­..."
            sleep 10
          fi
          
          # ä½¿ç”¨ä½ çš„start.shè„šæœ¬å¯åŠ¨æœåŠ¡å™¨
          ./start.sh
          
          echo "ğŸ® MinecraftæœåŠ¡å™¨é‡å¯å®Œæˆ"
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
